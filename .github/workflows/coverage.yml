name: Code Coverage

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests with coverage
        run: mvn clean test jacoco:report -B
        continue-on-error: true

      - name: Generate coverage report
        run: mvn jacoco:report-aggregate -B
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: |
            ./target/site/jacoco/jacoco.xml
            ./oauth-client/target/site/jacoco/jacoco.xml
            ./oauth-connector/connector-naver/target/site/jacoco/jacoco.xml
            ./oauth-connector/connector-kakao/target/site/jacoco/jacoco.xml
            ./oauth-connector/connector-google/target/site/jacoco/jacoco.xml
            ./oauth-connector/connector-facebook/target/site/jacoco/jacoco.xml
            ./oauth-storage/storage-redis/target/site/jacoco/jacoco.xml
            ./oauth-storage/storage-ehcache/target/site/jacoco/jacoco.xml
          fail_ci_if_error: false
          verbose: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Calculate coverage percentage
        id: coverage
        run: |
          # Find all jacoco.csv files and calculate overall coverage
          if find . -name "jacoco.csv" -type f | grep -q .; then
            # Extract coverage from jacoco.csv files
            TOTAL_MISSED=0
            TOTAL_COVERED=0

            for file in $(find . -name "jacoco.csv" -type f); do
              # Skip header and sum INSTRUCTION_MISSED and INSTRUCTION_COVERED
              while IFS=, read -r group package class instruction_missed instruction_covered branch_missed branch_covered line_missed line_covered complexity_missed complexity_covered method_missed method_covered; do
                if [[ "$group" != "GROUP" ]]; then
                  TOTAL_MISSED=$((TOTAL_MISSED + instruction_missed))
                  TOTAL_COVERED=$((TOTAL_COVERED + instruction_covered))
                fi
              done < "$file"
            done

            TOTAL=$((TOTAL_MISSED + TOTAL_COVERED))
            if [ $TOTAL -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.2f\", ($TOTAL_COVERED / $TOTAL) * 100}")
              echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
              echo "Total Coverage: $COVERAGE%"
            else
              echo "coverage=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "No coverage data found"
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi

      - name: Create coverage badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        if: github.ref == 'refs/heads/main'
        with:
          auth: ${{ secrets.GIST_TOKEN }}
          gistID: ${{ secrets.GIST_ID }}
          filename: sb-oauth-java-coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.coverage }}%
          color: |
            ${{
              steps.coverage.outputs.coverage >= 90 && 'brightgreen' ||
              steps.coverage.outputs.coverage >= 80 && 'green' ||
              steps.coverage.outputs.coverage >= 70 && 'yellowgreen' ||
              steps.coverage.outputs.coverage >= 60 && 'yellow' ||
              steps.coverage.outputs.coverage >= 50 && 'orange' ||
              'red'
            }}
        continue-on-error: true

      - name: Comment PR with coverage
        uses: madrapps/jacoco-report@v1.6.1
        if: github.event_name == 'pull_request'
        with:
          paths: |
            ${{ github.workspace }}/oauth-client/target/site/jacoco/jacoco.xml
            ${{ github.workspace }}/oauth-connector/connector-naver/target/site/jacoco/jacoco.xml
            ${{ github.workspace }}/oauth-connector/connector-kakao/target/site/jacoco/jacoco.xml
            ${{ github.workspace }}/oauth-connector/connector-google/target/site/jacoco/jacoco.xml
            ${{ github.workspace }}/oauth-connector/connector-facebook/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 50
          min-coverage-changed-files: 60
          title: 'Code Coverage Report'
          update-comment: true
        continue-on-error: true

      - name: Upload coverage reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            target/site/jacoco/
            */target/site/jacoco/
            */*/target/site/jacoco/
          retention-days: 30

      - name: Check coverage thresholds
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          echo "### Coverage Report :bar_chart:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Coverage**: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
            echo ":white_check_mark: Excellent coverage (>= 90%)" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            echo ":heavy_check_mark: Good coverage (>= 80%)" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
            echo ":warning: Acceptable coverage (>= 70%)" >> $GITHUB_STEP_SUMMARY
          elif (( $(echo "$COVERAGE >= 50" | bc -l) )); then
            echo ":warning: Minimum coverage met (>= 50%)" >> $GITHUB_STEP_SUMMARY
          else
            echo ":x: Coverage below minimum threshold (< 50%)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
