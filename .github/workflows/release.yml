name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0.0)'
        required: true
        type: string

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'temurin'
          cache: 'maven'

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update version in pom.xml
        run: |
          mvn versions:set -DnewVersion=${{ steps.version.outputs.VERSION }}
          mvn versions:commit

      - name: Build with Maven
        run: mvn clean package -DskipTests=false

      - name: Run tests
        run: mvn test

      - name: Generate Javadoc
        run: mvn javadoc:aggregate

      - name: Create artifacts
        run: |
          mkdir -p release-artifacts
          find . -name "*.jar" -not -path "*/target/test-classes/*" -exec cp {} release-artifacts/ \;
          cp CHANGELOG.md release-artifacts/
          cp README.md release-artifacts/
          cp LICENSE release-artifacts/

      - name: Generate changelog for release
        id: changelog
        run: |
          # Extract changelog for current version
          if grep -q "## \[${{ steps.version.outputs.VERSION }}\]" CHANGELOG.md; then
            sed -n "/## \[${{ steps.version.outputs.VERSION }}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release-notes.md
          else
            echo "## Changes" > release-notes.md
            echo "" >> release-notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release ${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          files: |
            release-artifacts/*.jar
            CHANGELOG.md
            README.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'RC') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Maven Central deployment (commented out until credentials are set up)
      # - name: Set up Maven settings
      #   run: |
      #     mkdir -p ~/.m2
      #     echo "<settings>
      #       <servers>
      #         <server>
      #           <id>ossrh</id>
      #           <username>${{ secrets.OSSRH_USERNAME }}</username>
      #           <password>${{ secrets.OSSRH_PASSWORD }}</password>
      #         </server>
      #       </servers>
      #     </settings>" > ~/.m2/settings.xml

      # - name: Import GPG key
      #   run: |
      #     echo "${{ secrets.GPG_PRIVATE_KEY }}" | base64 --decode | gpg --batch --import
      #     gpg --list-secret-keys --keyid-format LONG

      # - name: Deploy to Maven Central
      #   run: mvn clean deploy -P release -DskipTests=true
      #   env:
      #     GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: v${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: $(ls -1 release-artifacts/*.jar | wc -l) JAR files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify release on GitHub" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update documentation" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Announce release" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Deploy to Maven Central (when credentials are ready)" >> $GITHUB_STEP_SUMMARY
